<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pakistan National Students Database â€” Admin</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ8x0HwEACJ4gJbN+3C4QWk2F35/J/qH5S8eT7P0I4Jt0pQ2n4pQe0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{
      --accent:#0ea5a4;
      --muted:#64748b;
      --card-bg: rgba(255,255,255,0.95);
      --glass-border: rgba(0,0,0,0.1);
      --text-color: #0f172a;
    }
    body{
      background: #f1f5f9;
      color: var(--text-color);
      font-family: Inter, system-ui, Arial;
    }
    .glass{
      background: var(--card-bg);
      border:1px solid var(--glass-border);
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      backdrop-filter: blur(6px);
    }
    
    /* FIX: Search Result Card Responsiveness */
    .search-result-card {
        display: flex;
        flex-direction: column; /* Stack vertically on mobile */
        gap: 1.5rem;
        padding: 1.5rem;
    }
    @media (min-width: 768px) {
        .search-result-card {
            flex-direction: row; /* Side-by-side on larger screens */
        }
    }
    .search-result-card .photo-section {
        flex-shrink: 0;
        width: 100%;
        max-width: 160px;
        margin: 0 auto;
    }
     @media (min-width: 768px) {
        .search-result-card .photo-section {
            margin: 0;
        }
    }
    .search-result-card .details-section {
        flex-grow: 1;
        width: 100%;
    }
    .search-result-card input[readonly], .search-result-card textarea[readonly] {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        width: 100%;
        padding: 8px 10px;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    .search-result-card label {
        display: block;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--muted);
        margin-bottom: 2px;
    }
    .input-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    @media (min-width: 640px) {
        .input-grid { grid-template-columns: 1fr 1fr; }
    }
    .input-grid .col-span-full { grid-column: 1 / -1; }

    /* Color-Coded Status & Borders */
    .status-badge{ font-weight:700; padding:6px 12px; border-radius:999px; display:inline-flex; align-items:center; gap: 6px; font-size:.85rem; color:#fff; justify-content: center; }
    .badge-verified{ background:#10b981 }
    .badge-pending{ background:#f97316 }
    .badge-rejected{ background:#ef4444 }
    .badge-review{ background:#3b82f6 }
    .border-verified { border-color: #10b981 !important; box-shadow: 0 0 15px rgba(16, 185, 129, 0.35) !important; }
    .border-pending { border-color: #f97316 !important; box-shadow: 0 0 8px rgba(249, 115, 22, 0.2) !important; }
    .border-rejected { border-color: #ef4444 !important; box-shadow: 0 0 8px rgba(239, 68, 68, 0.2) !important; }
    .border-review { border-color: #3b82f6 !important; box-shadow: 0 0 8px rgba(59, 130, 246, 0.2) !important; }

    /* FIX: Modal Styling & Close Button */
    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); display: flex;
        justify-content: center; align-items: center; z-index: 10000;
        opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    .modal.active { opacity: 1; visibility: visible; }
    .modal-content {
        background: white; padding: 24px; border-radius: 12px;
        width: 90%; max-width: 750px; max-height: 90vh;
        overflow-y: auto; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        position: relative; transform: scale(0.95); transition: transform 0.3s;
    }
    .modal.active .modal-content { transform: scale(1); }
    .modal-close-btn {
        position: absolute; top: 12px; right: 12px;
        background: #e5e7eb; border-radius: 999px;
        width: 32px; height: 32px; display: flex;
        align-items: center; justify-content: center;
        font-size: 1.2rem; color: #4b5563; cursor: pointer;
        transition: background-color 0.2s, transform 0.2s;
    }
    .modal-close-btn:hover { background-color: #d1d5db; transform: rotate(90deg); }

    /* FIX: Modern Loading Animation Overlay */
    #loader-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 99999; backdrop-filter: blur(4px);
        opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    #loader-overlay.active { opacity: 1; visibility: visible; }
    .spinner {
        width: 56px; height: 56px;
        border: 6px solid #d1fae5;
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
  </style>
</head>
<body class="min-h-screen">

  <div id="loader-overlay">
    <div class="spinner"></div>
    <p id="loader-text" class="mt-4 text-lg font-semibold text-[--accent]">Loading...</p>
  </div>

  <header class="glass rounded-lg max-w-7xl mx-auto mt-6 p-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-4">
      <div class="logo-container w-12 h-12 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-lg flex items-center justify-content-center shadow-lg">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-5.247-8.247l10.494 4.99m-10.494-4.99l10.494 4.99M12 21.75V10.25m0 11.5a9.75 9.75 0 01-5.247-1.75m5.247 1.75a9.75 9.75 0 005.247-1.75M12 3.25a9.75 9.75 0 015.247 1.75M12 3.25a9.75 9.75 0 00-5.247 1.75"></path></svg>
      </div>
      <div>
        <div class="text-lg font-semibold">Pakistan National Students Database</div>
        <div class="text-sm text-[--muted]">Student Verification & Administration</div>
      </div>
    </div>
    
    <div id="user-session-container" class="flex items-center gap-3">
        <button id="btn-login" class="bg-[--accent] text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">Login</button>
        
        <div id="user-actions" class="hidden items-center gap-3">
            <span id="user-email-display" class="text-sm font-medium text-gray-600 hidden md:block"></span>
            <button id="btn-admin-panel" class="px-4 py-2 text-sm rounded-lg hover:bg-gray-100 font-medium transition">Admin Panel</button>
            <button id="btn-logout" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition">Logout</button>
        </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto mt-6 px-4 pb-12 space-y-6">

    <section id="section-search" class="glass rounded-lg p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-semibold">Search Student Records</h1>
          <p class="text-sm text-[--muted] mt-1">Search by exact name, roll number, or student ID.</p>
        </div>
        <div class="flex gap-3 w-full md:w-auto">
          <input id="search-input" type="text" placeholder="Enter full name, roll number, or ID..." class="flex-1 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[--accent] focus:border-[--accent]" />
          <button id="search-btn" class="bg-[--accent] text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90"><i class="fas fa-search"></i></button>
          <button id="clear-search" class="bg-gray-200 text-[--muted] px-4 py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-undo"></i></button>
        </div>
      </div>
      <div id="search-results" class="grid gap-6 mt-6">
          <div class="text-[--muted] p-6 text-center text-lg">Enter a full name, roll number, or student ID to begin.</div>
      </div>
    </section>

    <section id="section-login" class="hidden glass rounded-lg p-8 w-full max-w-md mx-auto shadow-xl">
        <h2 class="text-2xl font-bold mb-6 text-center text-[--accent]">Admin Login</h2>
        <form id="login-form" class="space-y-4">
            <div><label for="login-email" class="block text-sm font-medium">Email Address</label><input id="login-email" type="email" required class="w-full border rounded-lg px-3 py-2 mt-1 focus:ring-2 focus:ring-[--accent]" /></div>
            <div><label for="login-password" class="block text-sm font-medium">Password</label><input id="login-password" type="password" required class="w-full border rounded-lg px-3 py-2 mt-1 focus:ring-2 focus:ring-[--accent]" /></div>
            <p id="login-error" class="text-sm text-red-600 hidden text-center pt-2"></p>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-[--accent] text-white py-2 rounded-lg font-semibold hover:opacity-90">Sign In</button>
                <button id="cancel-login" type="button" class="flex-1 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>
            </div>
        </form>
    </section>

    <section id="section-admin" class="hidden space-y-6">
      <div class="glass rounded-lg p-6">
        <h2 id="student-form-title" class="text-xl font-semibold">Add New Student</h2>
        <form id="student-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
          <input type="hidden" id="student_id_edit">
          <input id="name" placeholder="Full Name *" class="md:col-span-2 border rounded-lg px-3 py-2" required>
          <input id="roll_number" placeholder="Roll Number *" class="border rounded-lg px-3 py-2" required>
          <input id="class" placeholder="Class" class="border rounded-lg px-3 py-2">
          <input id="father_name" placeholder="Father's Name" class="md:col-span-2 border rounded-lg px-3 py-2">
          <input id="father_contact" placeholder="Father's Contact" class="border rounded-lg px-3 py-2">
          <input id="contact_number" placeholder="Student Contact" class="border rounded-lg px-3 py-2">
          <input id="email_student" placeholder="Student Email" type="email" class="border rounded-lg px-3 py-2">
          <select id="gender" class="border rounded-lg px-3 py-2"><option value="">Gender</option><option>Male</option><option>Female</option></select>
          <input id="blood_group" placeholder="Blood Group" class="border rounded-lg px-3 py-2">
          <input id="dob" type="date" title="Date of Birth" class="border rounded-lg px-3 py-2">
          <input id="admission_date" type="date" title="Admission Date" class="border rounded-lg px-3 py-2">
          <input id="iq_level" placeholder="IQ Level" class="border rounded-lg px-3 py-2">
          <input id="photo" type="file" accept="image/*" class="md:col-span-2 border rounded-lg px-3 py-2 text-sm file:mr-2 file:py-1 file:px-2 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100" required>
          <select id="verification_status" class="border rounded-lg px-3 py-2" title="Verification Status"><option value="verified">Verified</option><option value="pending">Pending</option><option value="rejected">Rejected</option><option value="under_review">Under Review</option></select>
          <textarea id="address" placeholder="Complete Address" class="md:col-span-4 border rounded-lg px-3 py-2"></textarea>
          <div class="md:col-span-4 flex justify-end gap-3 pt-2">
            <button type="submit" id="btn-submit-student" class="bg-[--accent] text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90"><i class="fas fa-plus-circle mr-2"></i>Add Student</button>
            <button id="btn-cancel-edit" type="button" class="px-4 py-2 border rounded-lg hover:bg-gray-100 hidden"><i class="fas fa-times-circle mr-2"></i>Cancel Edit</button>
            <button id="btn-reset" type="button" class="px-4 py-2 border rounded-lg hover:bg-gray-100"><i class="fas fa-sync-alt mr-2"></i>Reset Form</button>
          </div>
        </form>
        <p id="form-message" class="text-sm mt-2 hidden"></p>
      </div>

      <div class="glass rounded-lg p-6">
        <h3 class="text-xl font-semibold">Manage All Students</h3>
        <div class="mt-4 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Photo</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name/ID</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Roll No.</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th><th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead><tbody id="admin-list-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody></table>
        </div>
      </div>
    </section>

    <div id="student-preview-modal" class="modal">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close-btn" title="Close">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-xl font-bold border-b pb-2 mb-4 text-[--accent]">Student Full Details</h3>
            <div id="modal-body"></div>
        </div>
    </div>
  </main>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL = 'https://gilsarbchgzjvcxgebcx.supabase.co'; 
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpbHNhcmJjaGd6anZjeGdlYmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNjI0NjcsImV4cCI6MjA3NTkzODQ2N30.OAz6OxL0OvAuPgy1h2GR6G07RM1zTrIkCCVSDO9tW1Q';
  const BUCKET_NAME = 'student-photos'; 
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // --- DOM Refs ---
  const loader = document.getElementById('loader-overlay');
  const loaderText = document.getElementById('loader-text');
  const sections = {
      search: document.getElementById('section-search'),
      login: document.getElementById('section-login'),
      admin: document.getElementById('section-admin'),
  };
  const btnLogin = document.getElementById('btn-login');
  const userActions = document.getElementById('user-actions');
  const userEmailDisplay = document.getElementById('user-email-display');
  const btnAdminPanel = document.getElementById('btn-admin-panel');
  const btnLogout = document.getElementById('btn-logout');
  const searchInput = document.getElementById('search-input');
  const searchBtn = document.getElementById('search-btn');
  const clearSearch = document.getElementById('clear-search');
  const searchResults = document.getElementById('search-results');
  const loginForm = document.getElementById('login-form');
  const studentForm = document.getElementById('student-form');
  const studentIdEdit = document.getElementById('student_id_edit');
  const adminListBody = document.getElementById('admin-list-body');
  const modal = document.getElementById('student-preview-modal');
  const modalBody = document.getElementById('modal-body');
  const modalCloseBtn = document.getElementById('modal-close-btn');

  let cachedStudents = [];

  // --- Utility Functions ---
  const showLoader = (text = 'Processing...') => { loaderText.textContent = text; loader.classList.add('active'); };
  const hideLoader = () => loader.classList.remove('active');
  const escapeHtml = (str) => String(str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]);

  const STATUS_CONFIG = {
    verified: {
      badge: 'badge-verified',
      html: `<i class="fas fa-check-circle"></i> Verified`
    },
    pending: {
      badge: 'badge-pending',
      html: `<i class="fas fa-clock"></i> Pending`
    },
    rejected: {
      badge: 'badge-rejected',
      html: `<i class="fas fa-times-circle"></i> Rejected`
    },
    under_review: {
      badge: 'badge-review',
      html: `<i class="fas fa-search"></i> In Review`
    }
  };

  const getStatus = (statusKey = 'pending') => STATUS_CONFIG[statusKey.toLowerCase()] || STATUS_CONFIG.pending;

  // --- App Logic ---
  const showSection = (sectionName) => {
      Object.values(sections).forEach(s => s.classList.add('hidden'));
      if (sections[sectionName]) sections[sectionName].classList.remove('hidden');
  };

  const onSignIn = (user) => {
      btnLogin.classList.add('hidden');
      userActions.classList.remove('hidden');
      userActions.classList.add('flex');
      userEmailDisplay.textContent = user.email;
  };

  const onSignOut = () => {
      btnLogin.classList.remove('hidden');
      userActions.classList.add('hidden');
      userActions.classList.remove('flex');
      userEmailDisplay.textContent = '';
      showSection('search');
  };
  
  const handleLogout = async () => {
      showLoader('Logging out...');
      await supabase.auth.signOut();
      onSignOut();
      hideLoader();
  };

  const doSearch = async () => {
      const query = searchInput.value.trim();
      if (!query) {
          searchResults.innerHTML = `<div class="text-[--muted] p-6 text-center text-lg">Enter a full name, roll number, or student ID to begin.</div>`;
          return;
      }
      showLoader('Searching...');
      const { data, error } = await supabase.from('students').select('*')
          .or(`name.eq.${query},roll_number.eq.${query},student_id.eq.${query}`);
      
      hideLoader();
      if (error) {
          searchResults.innerHTML = `<div class="text-red-500 p-4">Error: ${error.message}</div>`;
          return;
      }
      renderSearchResults(data);
  };

  const renderSearchResults = (list) => {
      if (!list || list.length === 0) {
          searchResults.innerHTML = `<div class="text-[--muted] p-6 text-center">No students found matching your query.</div>`;
          return;
      }
      searchResults.innerHTML = list.map(s => {
          const status = getStatus(s.verification_status);
          const photoUrl = escapeHtml(s.photo_url) || 'https://via.placeholder.com/160x180?text=No+Photo';
          return `
          <div class="glass rounded-lg search-result-card ${getBorderClass(s.verification_status)}">
              <div class="photo-section"><img src="${photoUrl}" class="w-full h-auto object-cover rounded-md shadow-md"><span class="status-badge ${status.badge} mt-3">${status.html}</span></div>
              <div class="details-section">
                  <h3 class="text-2xl font-bold text-[--accent] border-b pb-2 mb-4">${escapeHtml(s.name)}</h3>
                  <div class="input-grid">
                      <div><label>Student ID</label><input type="text" value="${escapeHtml(s.student_id)}" readonly></div>
                      <div><label>Roll Number</label><input type="text" value="${escapeHtml(s.roll_number)}" readonly></div>
                      <div><label>Class/Grade</label><input type="text" value="${escapeHtml(s.class)}" readonly></div>
                      <div><label>Father's Name</label><input type="text" value="${escapeHtml(s.father_name)}" readonly></div>
                      <div><label>DOB</label><input type="text" value="${escapeHtml(s.dob)}" readonly></div>
                      <div><label>Gender</label><input type="text" value="${escapeHtml(s.gender)}" readonly></div>
                      <div class="col-span-full"><label>Address</label><textarea rows="2" readonly>${escapeHtml(s.address)}</textarea></div>
                  </div>
                  <div class="mt-6 flex justify-end w-full border-t pt-4 gap-3">
                      <button class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 preview-btn" data-id="${s.id}"><i class="fas fa-eye mr-2"></i>Full Details</button>
                      <button class="px-4 py-2 bg-gray-200 text-black rounded-lg text-sm font-medium hover:bg-gray-300 print-btn" data-id="${s.id}"><i class="fas fa-file-pdf mr-2"></i>Download PDF</button>
                  </div>
              </div>
          </div>`;
      }).join('');
      
      searchResults.querySelectorAll('.preview-btn').forEach(btn => btn.addEventListener('click', (e) => showStudentPreviewModal(e.currentTarget.dataset.id)));
      searchResults.querySelectorAll('.print-btn').forEach(btn => btn.addEventListener('click', (e) => generatePdfForStudent(e.currentTarget.dataset.id)));
  };

  const showStudentPreviewModal = async (studentId) => {
      showLoader('Loading details...');
      const student = cachedStudents.find(s => s.id == studentId);
      if (!student) {
          hideLoader();
          alert('Student not found!');
          return;
      }
      const photoUrl = escapeHtml(student.photo_url) || 'https://via.placeholder.com/100x100?text=No+Photo';
      const status = getStatus(student.verification_status);
      modalBody.innerHTML = `
          <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
              <img src="${photoUrl}" class="w-24 h-24 object-cover rounded-md shadow-md flex-shrink-0">
              <div>
                  <h4 class="text-2xl font-bold text-[--accent]">${escapeHtml(student.name)}</h4>
                  <div class="text-sm text-gray-500 mt-1">ID: ${escapeHtml(student.student_id)}</div>
                  <span class="status-badge ${status.badge} mt-2">${status.html}</span>
              </div>
          </div>
          <div class="input-grid">
              ${Object.entries({
                  "Roll Number": student.roll_number, "Class/Grade": student.class, "Father's Name": student.father_name, "Father's Contact": student.father_contact,
                  "DOB": student.dob, "Gender": student.gender, "Blood Group": student.blood_group, "Student Contact": student.contact_number,
                  "IQ Level": student.iq_level, "Admission Date": student.admission_date
              }).map(([label, value]) => `<div><label>${label}</label><input type="text" value="${escapeHtml(value)}" readonly></div>`).join('')}
              <div class="col-span-full"><label>Email</label><input type="text" value="${escapeHtml(student.email_student)}" readonly></div>
              <div class="col-span-full"><label>Address</label><textarea rows="2" readonly>${escapeHtml(student.address)}</textarea></div>
          </div>`;
      hideLoader();
      modal.classList.add('active');
  };

  const loadStudentsAdmin = async () => {
      showLoader('Loading Students...');
      const { data, error } = await supabase.from('students').select('*').order('created_at', { ascending: false });
      hideLoader();
      if (error) {
          adminListBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
          return;
      }
      cachedStudents = data; // Crucial for other functions
      renderAdminList(data);
  };
  
  // FIX: Admin list with all action buttons
  const renderAdminList = (list) => {
      if (!list || list.length === 0) {
          adminListBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-[--muted]">No students found.</td></tr>`;
          return;
      }
      adminListBody.innerHTML = list.map(s => {
          const status = getStatus(s.verification_status);
          const photoUrl = escapeHtml(s.photo_url) || `https://ui-avatars.com/api/?name=${escapeHtml(s.name)}&background=random`;
          return `
          <tr class="hover:bg-gray-50">
              <td class="px-3 py-2"><img src="${photoUrl}" class="w-10 h-10 object-cover rounded-full border"></td>
              <td class="px-3 py-2 font-medium">${escapeHtml(s.name)}<div class="text-xs text-[--muted]">ID: ${escapeHtml(s.student_id)}</div></td>
              <td class="px-3 py-2">${escapeHtml(s.roll_number)}</td>
              <td class="px-3 py-2"><span class="status-badge text-xs ${status.badge}">${status.html}</span></td>
              <td class="px-3 py-2 text-right">
                  <div class="flex justify-end items-center gap-4 text-lg">
                      <button title="Preview" class="text-blue-600 hover:text-blue-800" onclick="window.showStudentPreviewModal(${s.id})"><i class="fas fa-eye"></i></button>
                      <button title="Download PDF" class="text-green-600 hover:text-green-800" onclick="window.generatePdfForStudent(${s.id})"><i class="fas fa-file-pdf"></i></button>
                      <button title="Edit" class="text-teal-600 hover:text-teal-800" onclick="window.openEditForm(${s.id})"><i class="fas fa-edit"></i></button>
                      <button title="Delete" class="text-red-600 hover:text-red-800" onclick="window.handleDeleteStudent(${s.id}, '${s.photo_url}')"><i class="fas fa-trash"></i></button>
                  </div>
              </td>
          </tr>`;
      }).join('');
  };
  
  const handleDeleteStudent = async (id, photoUrl) => {
      if (!confirm('Are you sure you want to delete this student? This action cannot be undone.')) return;
      showLoader('Deleting...');
      try {
          if (photoUrl && photoUrl.includes(BUCKET_NAME)) {
              const filePath = photoUrl.substring(photoUrl.indexOf(BUCKET_NAME) + BUCKET_NAME.length + 1);
              await supabase.storage.from(BUCKET_NAME).remove([filePath]);
          }
          const { error } = await supabase.from('students').delete().eq('id', id);
          if (error) throw error;
          await loadStudentsAdmin();
      } catch (error) {
          alert(`Error: ${error.message}`);
      } finally {
          hideLoader();
      }
  };
  
  const openEditForm = (id) => {
    const student = cachedStudents.find(s => s.id == id);
    if (!student) return;
    studentIdEdit.value = student.id;
    Object.keys(student).forEach(key => {
        if(studentForm.elements[key]) studentForm.elements[key].value = student[key] || '';
    });
    document.getElementById('student-form-title').textContent = `Edit Student: ${student.name}`;
    document.getElementById('btn-submit-student').innerHTML = `<i class="fas fa-save mr-2"></i>Save Changes`;
    document.getElementById('btn-cancel-edit').classList.remove('hidden');
    studentForm.elements.photo.required = false;
    sections.admin.scrollIntoView({ behavior: 'smooth' });
  };
  
  const resetForm = () => {
    studentForm.reset();
    studentIdEdit.value = '';
    document.getElementById('student-form-title').textContent = 'Add New Student';
    document.getElementById('btn-submit-student').innerHTML = `<i class="fas fa-plus-circle mr-2"></i>Add Student`;
    document.getElementById('btn-cancel-edit').classList.add('hidden');
    studentForm.elements.photo.required = true;
  };

  const handleSubmitStudent = async (e) => {
      e.preventDefault();
      const isEdit = !!studentIdEdit.value;
      showLoader(isEdit ? 'Updating...' : 'Adding...');
      const formData = new FormData(studentForm);
      const studentData = Object.fromEntries(formData.entries());
      delete studentData.photo; // Remove file from object
      
      try {
          const photoFile = studentForm.photo.files[0];
          if (photoFile) {
              const filePath = `public/${studentData.roll_number}_${Date.now()}.${photoFile.name.split('.').pop()}`;
              const { error } = await supabase.storage.from(BUCKET_NAME).upload(filePath, photoFile);
              if(error) throw error;
              studentData.photo_url = supabase.storage.from(BUCKET_NAME).getPublicUrl(filePath).data.publicUrl;
          }
          
          const { error } = isEdit
              ? await supabase.from('students').update(studentData).eq('id', studentIdEdit.value)
              : await supabase.from('students').insert({ ...studentData, student_id: `PNSD-${Date.now().toString().slice(-7)}` });
          
          if(error) throw error;
          resetForm();
          await loadStudentsAdmin();
      } catch (error) {
          alert(`Error: ${error.message}`);
      } finally {
          hideLoader();
      }
  };
  
  // FIX: Reliable PDF generation
  const generatePdfForStudent = async (studentId) => {
    showLoader('Generating PDF...');
    const student = cachedStudents.find(s => s.id == studentId);
    if (!student) { hideLoader(); alert('Student not found!'); return; }
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        
        // Fetch image as Base64
        let photoBase64 = null;
        if (student.photo_url) {
            try {
                const response = await fetch(student.photo_url);
                const blob = await response.blob();
                photoBase64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (e) { console.error("Could not load image for PDF:", e); }
        }

        doc.setFontSize(20).setFont('helvetica', 'bold').setTextColor('#0ea5a4').text('Student Verification Report', 105, 20, { align: 'center' });
        
        if (photoBase64) {
            doc.addImage(photoBase64, 'JPEG', 20, 30, 40, 40);
        } else {
            doc.setFillColor(230).rect(20, 30, 40, 40, 'F').setTextColor(150).text('No Photo', 40, 50, { align: 'center' });
        }

        doc.setFontSize(16).setTextColor('#0f172a').text(student.name, 70, 40);
        doc.setFontSize(10).setTextColor('#64748b').text(`ID: ${student.student_id} | Roll No: ${student.roll_number}`, 70, 48);

        const status = getStatus(student.verification_status);
        doc.setFillColor(status.badge.includes('verified') ? '#10b981' : status.badge.includes('pending') ? '#f97316' : '#ef4444').roundedRect(70, 55, 40, 8, 4, 4, 'F');
        doc.setFontSize(10).setTextColor('#ffffff').text(status.html.replace(/<[^>]*>/g, ''), 90, 60, { align: 'center' });

        doc.autoTable({
            startY: 80,
            head: [['Field', 'Details']],
            body: Object.entries({
                "Class": student.class, "Father's Name": student.father_name, "Gender": student.gender, "Date of Birth": student.dob, "Contact": student.contact_number, "Address": student.address
            }),
            theme: 'grid',
            headStyles: { fillColor: '#0ea5a4' },
            styles: { cellPadding: 2.5, fontSize: 10 }
        });
        
        doc.save(`${student.name}_Record.pdf`);
    } catch (e) {
        alert(`Failed to generate PDF: ${e.message}`);
    } finally {
        hideLoader();
    }
  };

  // --- Initial Setup & Event Listeners ---
  document.addEventListener('DOMContentLoaded', async () => {
      showLoader('Initializing...');
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
          onSignIn(session.user);
          await loadStudentsAdmin();
          showSection('admin');
      } else {
          onSignOut();
          showSection('search');
      }
      hideLoader();
  });
  
  // Expose functions to global window to be called from inline HTML onclick
  window.showStudentPreviewModal = showStudentPreviewModal;
  window.generatePdfForStudent = generatePdfForStudent;
  window.openEditForm = openEditForm;
  window.handleDeleteStudent = handleDeleteStudent;

  btnLogin.addEventListener('click', () => showSection('login'));
  btnAdminPanel.addEventListener('click', () => showSection('admin'));
  btnLogout.addEventListener('click', handleLogout);
  searchBtn.addEventListener('click', doSearch);
  clearSearch.addEventListener('click', () => { searchInput.value = ''; searchResults.innerHTML = ''; });
  document.getElementById('cancel-login').addEventListener('click', () => showSection('search'));
  loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      showLoader('Signing In...');
      const { email, password } = Object.fromEntries(new FormData(loginForm));
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
          document.getElementById('login-error').textContent = error.message;
          document.getElementById('login-error').classList.remove('hidden');
          hideLoader();
      } else {
          onSignIn(data.user);
          await loadStudentsAdmin();
          showSection('admin');
          hideLoader();
      }
  });
  studentForm.addEventListener('submit', handleSubmitStudent);
  document.getElementById('btn-reset').addEventListener('click', resetForm);
  document.getElementById('btn-cancel-edit').addEventListener('click', resetForm);
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });
  modalCloseBtn.addEventListener('click', () => modal.classList.remove('active'));

</script>
</body>
</html>
