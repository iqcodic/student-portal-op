<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pakistan National Students Database â€” Admin</title>

  <!-- Tailwind (quick) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --accent:#0ea5a4; --muted:#94a3b8;
      --card-bg: rgba(255,255,255,0.03);
      --glass-border: rgba(255,255,255,0.04);
    }
    body{ background: linear-gradient(180deg,#071125 0%, #071426 60%); color:#e6eef6; font-family: Inter, system-ui, Arial;}
    .glass{ background: var(--card-bg); border:1px solid var(--glass-border); backdrop-filter: blur(6px); }
    .rounded-card{ border-radius:12px; }
    .card-hover{ transition: transform .16s ease, box-shadow .16s ease; }
    .card-hover:hover{ transform: translateY(-6px); box-shadow: 0 18px 36px rgba(2,6,23,.6); }
    .status-badge{ font-weight:700; padding:6px 10px; border-radius:999px; display:inline-block; font-size:.85rem; color:#fff; }
    .badge-verified{ background:#16a34a } .badge-pending{ background:#f59e0b } .badge-rejected{ background:#dc2626 } .badge-review{ background:#2563eb }
    @media (max-width:760px){ .desktop-only{ display:none } }
  </style>
</head>
<body class="min-h-screen">

  <!-- HEADER -->
  <header class="glass rounded-card max-w-7xl mx-auto mt-6 p-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-4">
      <div style="width:46px;height:46px;border-radius:10px;background:linear-gradient(45deg,#0ea5a4,#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700;color:#05263b">PN</div>
      <div>
        <div class="text-lg font-semibold">Pakistan National Students Database</div>
        <div class="text-sm text-[--muted]">Student verification & administration</div>
      </div>
    </div>
    <nav class="flex items-center gap-3">
      <button id="nav-search" class="px-3 py-2 text-sm rounded hover:bg-white/5">Search</button>
      <button id="nav-admin" class="px-3 py-2 text-sm rounded hover:bg-white/5 desktop-only">Admin</button>
      <div id="session-email" class="text-sm text-[--muted] hidden"></div>
      <button id="btn-login" class="ml-2 bg-[--accent] text-black px-3 py-2 rounded">Login</button>
      <button id="btn-logout" class="ml-2 bg-red-600 text-white px-3 py-2 rounded hidden">Logout</button>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto mt-6 px-4 pb-12 space-y-6">

    <!-- SEARCH -->
    <section id="section-search" class="glass rounded-card p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-semibold">Search Student</h1>
          <p class="text-sm text-[--muted] mt-1">Search by name or roll number</p>
        </div>
        <div class="flex gap-3 w-full md:w-auto">
          <input id="search-input" type="text" placeholder="Enter name or roll number..." class="flex-1 border border-white/6 rounded px-4 py-2" />
          <button id="search-btn" class="bg-[--accent] text-black px-4 py-2 rounded">Search</button>
          <button id="clear-search" class="bg-white/5 text-[--muted] px-4 py-2 rounded">Clear</button>
        </div>
      </div>
      <div id="search-results" class="grid gap-4 mt-6 sm:grid-cols-2 lg:grid-cols-3"></div>
    </section>

    <!-- LOGIN -->
    <section id="section-login" class="hidden glass rounded-card p-6 max-w-md mx-auto">
      <h2 class="text-lg font-semibold mb-2">Admin Login</h2>
      <form id="login-form" class="space-y-3">
        <input id="login-email" type="email" placeholder="Email" required class="w-full border border-white/6 rounded px-3 py-2" />
        <input id="login-password" type="password" placeholder="Password" required class="w-full border border-white/6 rounded px-3 py-2" />
        <div class="flex gap-3">
          <button type="submit" class="bg-[--accent] text-black px-4 py-2 rounded">Sign in</button>
          <button id="cancel-login" type="button" class="px-4 py-2 border rounded">Cancel</button>
        </div>
        <p id="login-error" class="text-sm text-rose-400 hidden"></p>
      </form>
    </section>

    <!-- ADMIN -->
    <section id="section-admin" class="hidden space-y-6">

      <!-- ADD STUDENT -->
      <div class="glass rounded-card p-6">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xl font-semibold">Add Student</h2>
            <p class="text-sm text-[--muted]">Fill details and upload photo (Admins only)</p>
          </div>
        </div>

        <form id="student-form" class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
          <input id="name" placeholder="Full Name *" class="md:col-span-2 border border-white/6 rounded px-3 py-2" required>
          <input id="roll_number" placeholder="Roll Number *" class="border border-white/6 rounded px-3 py-2" required>

          <input id="email_student" placeholder="Student Email" class="border border-white/6 rounded px-3 py-2">
          <select id="gender" class="border border-white/6 rounded px-3 py-2">
            <option value="">Gender</option><option>Male</option><option>Female</option><option>Other</option>
          </select>
          <input id="class" placeholder="Class" class="border border-white/6 rounded px-3 py-2">

          <input id="father_name" placeholder="Father's Name" class="md:col-span-2 border border-white/6 rounded px-3 py-2">
          <input id="father_contact" placeholder="Father's Contact" class="border border-white/6 rounded px-3 py-2">

          <input id="blood_group" placeholder="Blood Group (A+)" class="border border-white/6 rounded px-3 py-2">
          <input id="dob" type="date" class="border border-white/6 rounded px-3 py-2">
          <input id="admission_date" type="date" class="border border-white/6 rounded px-3 py-2">

          <input id="photo" type="file" accept="image/*" class="md:col-span-3 border border-white/6 rounded px-3 py-2">

          <select id="verification_status" class="md:col-span-3 border border-white/6 rounded px-3 py-2">
            <option value="verified">Verified</option>
            <option value="pending">Pending</option>
            <option value="rejected">Rejected</option>
            <option value="under_review">Under Review</option>
          </select>

          <div class="md:col-span-3 flex justify-end gap-3">
            <button id="btn-add-student" class="bg-emerald-500 text-black px-4 py-2 rounded">Add Student</button>
            <button id="btn-reset" type="button" class="px-4 py-2 border rounded">Reset</button>
          </div>
        </form>

        <p id="form-message" class="text-sm mt-2 hidden"></p>
      </div>

      <!-- ADMIN LIST -->
      <div class="glass rounded-card p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">All Students</h3>
          <div class="flex items-center gap-2">
            <button id="btn-refresh" class="px-3 py-1 border rounded">Refresh</button>
            <button id="btn-export" class="px-3 py-1 bg-[--accent] text-black rounded">Export CSV</button>
          </div>
        </div>

        <div id="admin-list" class="grid gap-4 mt-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      </div>
    </section>

  </main>

  <!-- PREVIEW MODAL (in-page) -->
  <div id="preview-modal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative max-w-3xl w-full p-4">
      <div class="glass rounded-card p-4">
        <div class="flex justify-between items-start gap-4">
          <div>
            <div id="preview-name" class="text-xl font-semibold">Student Name</div>
            <div id="preview-sub" class="text-sm text-[--muted]">Roll: â€” â€¢ ID: â€”</div>
          </div>
          <div class="flex gap-2 items-center">
            <span id="preview-badge" class="status-badge">STATUS</span>
            <button id="preview-pdf" class="px-3 py-2 bg-black text-white rounded">ðŸ“„ PDF</button>
            <button id="preview-close" class="px-3 py-2 border rounded">Close</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="md:col-span-1">
            <img id="preview-photo" src="https://via.placeholder.com/400x400?text=No+Photo" class="w-full h-56 object-cover rounded" />
          </div>
          <div class="md:col-span-2">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div><div class="text-sm text-[--muted]">Father</div><div id="preview-father" class="font-semibold"></div></div>
              <div><div class="text-sm text-[--muted]">Father Contact</div><div id="preview-father-contact" class="font-semibold"></div></div>
              <div><div class="text-sm text-[--muted]">Class</div><div id="preview-class" class="font-semibold"></div></div>
              <div><div class="text-sm text-[--muted]">DOB</div><div id="preview-dob" class="font-semibold"></div></div>
              <div><div class="text-sm text-[--muted]">Blood Group</div><div id="preview-blood" class="font-semibold"></div></div>
              <div><div class="text-sm text-[--muted]">Admission Date</div><div id="preview-admission" class="font-semibold"></div></div>
            </div>
            <div class="mt-4 text-sm text-[--muted]">Authorized and checked by: <strong>Muhammad Bilal</strong><br>Organization: Pakistan National Students Database<br>Date: <span id="preview-date"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ---------------- CONFIG - update if needed ----------------
  const SUPABASE_URL = 'https://gilsarbchgzjvcxgebcx.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpbHNhcmJjaGd6anZjeGdlYmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNjI0NjcsImV4cCI6MjA3NTkzODQ2N30.OAz6OxL0OvAuPgy1h2GR6G07RM1zTrIkCCVSDO9tW1Q';
  const BUCKET_NAME = 'student-photos';
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
  // ----------------------------------------------------------

  // DOM refs
  const navSearch = document.getElementById('nav-search');
  const navAdmin = document.getElementById('nav-admin');
  const btnLogin = document.getElementById('btn-login');
  const btnLogout = document.getElementById('btn-logout');
  const sessionEmail = document.getElementById('session-email');

  const sectionSearch = document.getElementById('section-search');
  const sectionLogin = document.getElementById('section-login');
  const sectionAdmin = document.getElementById('section-admin');

  const searchInput = document.getElementById('search-input');
  const searchBtn = document.getElementById('search-btn');
  const clearSearch = document.getElementById('clear-search');
  const searchResults = document.getElementById('search-results');

  const loginForm = document.getElementById('login-form');
  const loginError = document.getElementById('login-error');
  const cancelLogin = document.getElementById('cancel-login');

  const studentForm = document.getElementById('student-form');
  const btnReset = document.getElementById('btn-reset');
  const formMessage = document.getElementById('form-message');

  const adminList = document.getElementById('admin-list');
  const btnRefresh = document.getElementById('btn-refresh');
  const btnExport = document.getElementById('btn-export');

  // modal refs
  const previewModal = document.getElementById('preview-modal');
  const previewName = document.getElementById('preview-name');
  const previewSub = document.getElementById('preview-sub');
  const previewBadge = document.getElementById('preview-badge');
  const previewPhoto = document.getElementById('preview-photo');
  const previewFather = document.getElementById('preview-father');
  const previewFatherContact = document.getElementById('preview-father-contact');
  const previewClass = document.getElementById('preview-class');
  const previewDob = document.getElementById('preview-dob');
  const previewBlood = document.getElementById('preview-blood');
  const previewAdmission = document.getElementById('preview-admission');
  const previewDate = document.getElementById('preview-date');
  const previewPdfBtn = document.getElementById('preview-pdf');
  const previewCloseBtn = document.getElementById('preview-close');

  let cachedStudents = [];
  let currentPreviewStudent = null;

  // basic wiring
  navSearch.addEventListener('click', ()=> showSection('search'));
  navAdmin.addEventListener('click', ()=> checkAuthAndShowAdmin());
  btnLogin.addEventListener('click', ()=> showSection('login'));
  btnLogout.addEventListener('click', async ()=> { await supabase.auth.signOut(); onSignOut(); alert('Signed out'); });
  cancelLogin?.addEventListener('click', ()=> showSection('search'));
  searchBtn.addEventListener('click', async ()=> { await doSearch(searchInput.value.trim()); });
  clearSearch.addEventListener('click', ()=> { searchInput.value=''; searchResults.innerHTML=''; });

  (async function init(){
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) onSignIn(session.user.email);
    else onSignOut();
    showSection('search');
    await preloadStudents();
  })();

  function showSection(name){
    sectionSearch.classList.add('hidden');
    sectionLogin.classList.add('hidden');
    sectionAdmin.classList.add('hidden');
    if (name === 'search') sectionSearch.classList.remove('hidden');
    if (name === 'login') sectionLogin.classList.remove('hidden');
    if (name === 'admin') sectionAdmin.classList.remove('hidden');
  }

  function onSignIn(email){
    btnLogin.classList.add('hidden'); btnLogout.classList.remove('hidden'); navAdmin.classList.remove('hidden');
    sessionEmail.textContent = email; sessionEmail.classList.remove('hidden');
  }
  function onSignOut(){
    btnLogin.classList.remove('hidden'); btnLogout.classList.add('hidden'); navAdmin.classList.add('hidden');
    sessionEmail.classList.add('hidden'); showSection('search');
  }

  async function checkAuthAndShowAdmin(){
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) showSection('login');
    else { onSignIn(session.user.email); showSection('admin'); await loadStudentsAdmin(); }
  }

  // ---------- AUTH ----------
  loginForm?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    loginError.classList.add('hidden');
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) { loginError.textContent = error.message; loginError.classList.remove('hidden'); return; }
    if (data?.user) { onSignIn(data.user.email); showSection('admin'); await loadStudentsAdmin(); await preloadStudents(); }
    else { loginError.textContent = 'Login failed'; loginError.classList.remove('hidden'); }
  });

  // ---------- PRELOAD ----------
  async function preloadStudents(){
    try {
      const { data } = await supabase.from('students').select('*').order('created_at',{ascending:false}).limit(500);
      cachedStudents = data || [];
    } catch (err){ console.error(err); cachedStudents = []; }
  }

  // ---------- SEARCH ----------
  async function doSearch(q){
    searchResults.innerHTML = `<div class="text-sm text-[--muted]">Searching...</div>`;
    if (!q){ renderSearchResults(cachedStudents.slice(0,50)); return; }
    const lower = q.toLowerCase();
    const local = cachedStudents.filter(s => (s.name||'').toLowerCase().includes(lower) || (s.roll_number||'').toLowerCase().includes(lower));
    if (local.length) { renderSearchResults(local); return; }
    const { data, error } = await supabase.from('students').select('*').or(`name.ilike.%${q}%,roll_number.ilike.%${q}%`).order('created_at',{ascending:false}).limit(200);
    if (error) { searchResults.innerHTML = `<div class="text-rose-400">Search failed: ${error.message}</div>`; return; }
    cachedStudents = data || [];
    renderSearchResults(cachedStudents);
  }

  function renderSearchResults(list){
    searchResults.innerHTML = '';
    if (!list || list.length === 0){ searchResults.innerHTML = `<div class="text-[--muted]">No students found</div>`; return; }
    list.forEach(s => {
      const wrapper = document.createElement('div');
      wrapper.className = 'bg-gradient-to-b from-white/2 to-transparent rounded overflow-hidden card-hover';
      wrapper.innerHTML = `
        <img src="${escapeHtml(s.photo_url) || 'https://via.placeholder.com/800x500?text=No+Photo'}" class="w-full h-44 object-cover">
        <div class="p-3">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-semibold">${escapeHtml(s.name)}</h3>
              <div class="text-sm text-[--muted] mt-1">Roll: <b>${escapeHtml(s.roll_number)}</b></div>
            </div>
            <div class="text-sm text-[--muted]">ID: ${escapeHtml(s.student_id||'')}</div>
          </div>
          <div class="mt-3 flex justify-between items-center">
            <div class="text-sm text-[--muted]">${escapeHtml(s.class||'')}</div>
            <div><button class="px-3 py-1 border rounded text-sm preview-btn" data-id="${s.id}">Preview</button></div>
          </div>
        </div>
      `;
      searchResults.appendChild(wrapper);
    });

    // attach preview events
    document.querySelectorAll('.preview-btn').forEach(btn => {
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-id');
        const student = cachedStudents.find(x => String(x.id) === String(id));
        if (!student) {
          const { data } = await supabase.from('students').select('*').eq('id', id).single();
          openPreviewModal(data);
        } else openPreviewModal(student);
      });
    });
  }

  // ---------- PREVIEW MODAL ----------
  function openPreviewModal(student){
    if (!student) return alert('Student data not found');
    currentPreviewStudent = student;
    previewName.textContent = student.name || '';
    previewSub.textContent = `Roll: ${student.roll_number || '-'} â€¢ ID: ${student.student_id || '-'}`;
    previewPhoto.src = student.photo_url || 'https://via.placeholder.com/400x400?text=No+Photo';
    previewFather.textContent = student.father_name || '-';
    previewFatherContact.textContent = student.father_contact || '-';
    previewClass.textContent = student.class || '-';
    previewDob.textContent = student.dob || '-';
    previewBlood.textContent = student.blood_group || '-';
    previewAdmission.textContent = student.admission_date || '-';
    previewDate.textContent = new Date().toLocaleDateString();

    // badge
    const status = (student.verification_status || 'pending').toLowerCase();
    previewBadge.className = 'status-badge ' + (status === 'verified' ? 'badge-verified' : status === 'pending' ? 'badge-pending' : status === 'rejected' ? 'badge-rejected' : 'badge-review');
    previewBadge.textContent = statusLabel(status);

    previewModal.classList.remove('hidden');
    previewModal.style.display = 'flex';
  }
  previewCloseBtn.addEventListener('click', ()=> {
    previewModal.classList.add('hidden'); previewModal.style.display = 'none'; currentPreviewStudent = null;
  });

  previewPdfBtn.addEventListener('click', async ()=>{
    if (!currentPreviewStudent) return;
    await generatePdfForStudent(currentPreviewStudent);
  });

  // ---------- PDF Generation ----------
  async function generatePdfForStudent(student){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','mm','a4');

    // header
    doc.setFillColor(10,20,30);
    doc.rect(0,0,210,20,'F');
    doc.setFontSize(14);
    doc.setTextColor(255,255,255);
    doc.text('Pakistan National Students Database', 105, 13, { align: 'center' });

    // load image
    let imgData = null;
    if (student.photo_url) {
      try {
        const resp = await fetch(student.photo_url);
        const blob = await resp.blob();
        imgData = await blobToDataURL(blob);
      } catch (err) {
        console.warn('photo load failed', err);
        imgData = null;
      }
    }

    if (imgData) doc.addImage(imgData, 'JPEG', 80, 30, 50, 50);
    else { doc.rect(80,30,50,50); doc.setFontSize(10); doc.text('No photo', 105, 60, { align: 'center' }); }

    doc.setFontSize(16); doc.setTextColor(0);
    doc.text('CANDIDATE INFORMATION', 105, 95, { align: 'center' });

    // left/right columns
    let y = 105;
    const leftX = 20; const rightX = 110;
    const push = (x,label,val) => {
      doc.setFontSize(9); doc.setTextColor(100); doc.text(label, x, y);
      doc.setFontSize(11); doc.setTextColor(0); doc.text(String(val||'N/A'), x, y+6);
    };

    push(leftX, 'Name:', student.name); push(rightX, 'Gender:', student.gender);
    y += 18;
    push(leftX, 'Roll Number:', student.roll_number); push(rightX, 'Student ID:', student.student_id);
    y += 18;
    push(leftX, 'Father:', student.father_name); push(rightX, 'Father Contact:', student.father_contact);
    y += 18;
    push(leftX, 'Class:', student.class); push(rightX, 'DOB:', student.dob);
    y += 18;
    push(leftX, 'Blood Group:', student.blood_group); push(rightX, 'Admission Date:', student.admission_date);
    y += 22;

    // status
    const stText = statusLabel((student.verification_status||'pending').toLowerCase());
    const stRgb = statusRgb((student.verification_status||'pending').toLowerCase());
    doc.setFontSize(12); doc.setTextColor(...stRgb); doc.text('Status: ' + stText, 20, y);

    // footer
    const footerY = 270;
    doc.setLineWidth(0.5); doc.line(15, footerY-8, 195, footerY-8);
    doc.setFontSize(10); doc.setTextColor(100);
    doc.text(`Authorized and checked by: Muhammad Bilal`, 20, footerY);
    doc.text(`Organization: Pakistan National Students Database`, 20, footerY+6);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, footerY+12);

    doc.save(`${(student.name||'student').replace(/\s+/g,'_')}_verification.pdf`);
  }

  function blobToDataURL(blob){
    return new Promise((res,rej)=>{
      const reader = new FileReader();
      reader.onload = ()=> res(reader.result);
      reader.onerror = rej;
      reader.readAsDataURL(blob);
    });
  }

  function statusLabel(s){
    if (!s) return 'UNVERIFIED';
    if (s === 'verified') return 'VERIFIED';
    if (s === 'pending') return 'PENDING';
    if (s === 'rejected') return 'REJECTED';
    if (s === 'under_review' || s==='under review') return 'UNDER REVIEW';
    return s.toUpperCase();
  }
  function statusRgb(s){
    if (s === 'verified') return [22,163,74];
    if (s === 'pending') return [245,158,11];
    if (s === 'rejected') return [220,38,38];
    if (s === 'under_review' || s==='under review') return [37,99,235];
    return [108,117,125];
  }

  // ---------- ADD STUDENT ----------
  studentForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    formMessage.classList.add('hidden');

    // ensure authenticated
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) { alert('Please login as admin before adding student.'); showSection('login'); return; }

    const payload = {
      student_id: generateStudentId(),
      name: document.getElementById('name').value.trim(),
      roll_number: document.getElementById('roll_number').value.trim(),
      email: document.getElementById('email_student').value.trim() || null,
      gender: document.getElementById('gender').value || null,
      father_name: document.getElementById('father_name').value.trim() || null,
      father_contact: document.getElementById('father_contact').value.trim() || null,
      blood_group: document.getElementById('blood_group').value.trim() || null,
      class: document.getElementById('class').value.trim() || null,
      dob: document.getElementById('dob').value || null,
      admission_date: document.getElementById('admission_date').value || null,
      verification_status: document.getElementById('verification_status').value || 'pending'
    };

    if (!payload.name || !payload.roll_number){ showFormMessage('Name and Roll number required', true); return; }

    // upload photo if present
    const photoInput = document.getElementById('photo');
    if (photoInput.files && photoInput.files[0]) {
      const file = photoInput.files[0];
      const ext = file.name.split('.').pop();
      const path = `${Date.now()}_${Math.random().toString(36).slice(2,9)}.${ext}`;
      const { error: upErr } = await supabase.storage.from(BUCKET_NAME).upload(path, file, { cacheControl:'3600', upsert:false });
      if (upErr) {
        if (upErr.message && upErr.message.toLowerCase().includes('row-level')) {
          showFormMessage('Upload failed: RLS/storage policy blocked action. Ensure authenticated and storage policy allows inserts.', true);
          return;
        }
        showFormMessage('Upload failed: ' + upErr.message, true);
        return;
      }
      // get public url (note: getPublicUrl does not require await)
      const { data: publicData } = supabase.storage.from(BUCKET_NAME).getPublicUrl(path);
      payload.photo_url = publicData?.publicUrl || publicData?.public_url || null;
    }

    const { error } = await supabase.from('students').insert([payload]);
    if (error) {
      if (error.message && error.message.toLowerCase().includes('row-level')) {
        showFormMessage('Insert rejected by RLS. Make sure you are logged in as admin and RLS policy allows inserts for authenticated role.', true);
      } else showFormMessage('Error adding student: ' + error.message, true);
      return;
    }

    showFormMessage('Student added successfully âœ“', false);
    studentForm.reset();
    await loadStudentsAdmin(); await preloadStudents();
  });

  btnReset.addEventListener('click', ()=> studentForm.reset());
  function generateStudentId(){
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let out = '';
    for (let i=0;i<8;i++) out += chars.charAt(Math.floor(Math.random()*chars.length));
    return out;
  }
  function showFormMessage(msg,isErr){
    formMessage.textContent = msg; formMessage.classList.remove('hidden');
    formMessage.classList.toggle('text-rose-400', !!isErr); formMessage.classList.toggle('text-emerald-400', !isErr);
    setTimeout(()=> formMessage.classList.add('hidden'),5000);
  }

  // ---------- ADMIN LIST ----------
  async function loadStudentsAdmin(){
    adminList.innerHTML = `<div class="text-[--muted]">Loading...</div>`;
    const { data, error } = await supabase.from('students').select('*').order('created_at',{ascending:false}).limit(1000);
    if (error) { adminList.innerHTML = `<div class="text-rose-400">Failed: ${error.message}</div>`; return; }
    renderAdminList(data || []);
  }
  function renderAdminList(list){
    adminList.innerHTML = '';
    if (!list.length){ adminList.innerHTML = `<div class="text-[--muted]">No students yet.</div>`; return; }
    list.forEach(s=>{
      const card = document.createElement('div'); card.className='bg-white/3 rounded p-3 card-hover';
      card.innerHTML = `
        <img src="${escapeHtml(s.photo_url) || 'https://via.placeholder.com/800x500?text=No+Photo'}" class="w-full h-36 object-cover rounded mb-2">
        <div class="font-semibold">${escapeHtml(s.name)}</div>
        <div class="text-xs text-[--muted]">ID: ${escapeHtml(s.student_id||'')}</div>
        <div class="text-sm text-[--muted] mt-2">Roll: <b>${escapeHtml(s.roll_number)}</b> â€¢ ${escapeHtml(s.class||'-')}</div>
        <div class="flex justify-between items-center mt-3">
          <div class="text-sm">${escapeHtml(statusLabel(s.verification_status||''))}</div>
          <div class="flex gap-2">
            <button data-id="${s.id}" class="btn-preview px-3 py-1 border rounded text-sm">Preview</button>
            <button data-id="${s.id}" class="btn-delete px-3 py-1 border rounded text-sm text-rose-400">Delete</button>
          </div>
        </div>
      `;
      adminList.appendChild(card);
    });

    document.querySelectorAll('.btn-preview').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.dataset.id;
        const s = cachedStudents.find(x => String(x.id) === String(id));
        if (s) openPreviewModal(s);
      });
    });
    document.querySelectorAll('.btn-delete').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.id;
        if (!confirm('Delete student?')) return;
        const { error } = await supabase.from('students').delete().match({ id });
        if (error) return alert('Delete failed: ' + error.message);
        await loadStudentsAdmin(); await preloadStudents();
      });
    });
  }

  btnRefresh.addEventListener('click', loadStudentsAdmin);

  btnExport.addEventListener('click', async ()=>{
    const { data, error } = await supabase.from('students').select('*').order('created_at',{ascending:false}).limit(2000);
    if (error) return alert('Export failed: ' + error.message);
    if (!data || !data.length) return alert('No data to export');
    const csv = toCSV(data);
    const blob = new Blob([csv], { type:'text/csv' }); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'students.csv'; a.click(); URL.revokeObjectURL(url);
  });

  function toCSV(rows){
    const cols = ['student_id','name','roll_number','email','gender','father_name','father_contact','blood_group','class','dob','admission_date','photo_url','verification_status','created_at'];
    const header = cols.join(',') + '\n';
    const body = rows.map(r => cols.map(c => `"${(r[c] ?? '').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
    return header + body;
  }

  function escapeHtml(s){ if (s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

</script>
</body>
</html>
