<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pakistan National Students Database â€” Admin</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ8x0HwEACJ4gJbN+3C4QWk2F35/J/qH5S8eT7P0I4Jt0pQ2n4pQe0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    /* LIGHT THEME STYLES */
    :root{
      --accent:#0ea5a4; /* Teal */
      --muted:#64748b; /* Slate */
      --card-bg: rgba(255,255,255,0.95);
      --glass-border: rgba(0,0,0,0.1);
      --text-color: #0f172a;
    }
    body{
      background: #f1f5f9; /* Light slate background */
      color: var(--text-color);
      font-family: Inter, system-ui, Arial;
    }
    .glass{
      background: var(--card-bg);
      border:1px solid var(--glass-border);
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      backdrop-filter: blur(6px);
    }
    .rounded-card{ border-radius:12px; }
    .card-hover{ transition: transform .16s ease, box-shadow .16s ease; }
    .card-hover:hover{ transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,.1); }

    /* Color-Coded Status Styling */
    .status-badge{ 
        font-weight:700; 
        padding:6px 10px; 
        border-radius:999px; 
        display:inline-flex; 
        align-items:center; 
        font-size:.85rem; 
        color:#fff; 
        min-width: 100px;
        justify-content: center;
    }
    .status-badge svg { margin-right: 4px; }
    .badge-verified{ background:#10b981 } /* Emerald (Green) */
    .badge-pending{ background:#f97316 } /* Orange (Amber) */
    .badge-rejected{ background:#ef4444 } /* Red */
    .badge-review{ background:#3b82f6 } /* Blue */

    input, select, textarea {
        border-color: rgba(0,0,0,0.1) !important;
        color: var(--text-color);
        background-color: white;
    }

    /* FIX: Styling for Read-only inputs in search results */
    .search-result-card input[readonly], .search-result-card textarea[readonly] {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        cursor: text; 
        border-radius: 6px;
        padding: 8px 10px; 
        font-size: 0.9rem;
        transition: border-color 0.1s;
        width: 100%;
    }
    .search-result-card input[readonly]:focus,
    .search-result-card input[readonly]:hover {
        border-color: #cbd5e1;
        outline: none;
    }
    .search-result-card label {
        display: block;
        color: var(--muted);
        font-weight: 500;
        font-size: 0.75rem;
        margin-bottom: 2px;
    }

    /* FIX: Responsive Grid for Search Card */
    .search-result-card {
        border: 2px solid var(--glass-border); 
        background: #ffffff;
        border-radius: 12px; 
        padding: 1.5rem;
        display: flex; /* Changed to flex */
        flex-direction: column; /* Stack vertically on mobile */
        gap: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    @media (min-width: 768px) { /* Changed breakpoint for better layout */
        .search-result-card {
            flex-direction: row; /* Side-by-side on larger screens */
        }
    }
    .student-photo-section {
        flex-shrink: 0;
        width: 100%;
        max-width: 160px; /* Limit photo section width */
        margin: 0 auto; /* Center on mobile */
    }
    @media (min-width: 768px) {
        .student-photo-section {
            margin: 0;
        }
    }
    .student-details-section {
        flex-grow: 1; /* Allow details to take remaining space */
    }
    
    /* WAFID-style Border Color Reaction */
    .border-verified { border-color: #10b981 !important; box-shadow: 0 0 15px rgba(16, 185, 129, 0.35) !important; }
    .border-pending { border-color: #f97316 !important; box-shadow: 0 0 8px rgba(249, 115, 22, 0.2) !important; }
    .border-rejected { border-color: #ef4444 !important; box-shadow: 0 0 8px rgba(239, 68, 68, 0.2) !important; }
    .border-review { border-color: #3b82f6 !important; box-shadow: 0 0 8px rgba(59, 130, 246, 0.2) !important; }

    /* FIX: Improved Logo/Nav UI */
    .logo-container {
        width: 44px;
        height: 44px;
        border-radius: 8px;
        background:linear-gradient(45deg,#0ea5a4,#06b6d4);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(14, 165, 164, 0.3);
    }
    .logo-container svg {
        width: 28px;
        height: 28px;
        fill: white;
    }
    /* FIX: Ensure Nav bar content does not get squashed */
    header .flex-1 { flex: 1 1 0%; }
    header .flex-auto { flex: 1 1 auto; }
    header .flex-none { flex: none; }
    
    /* FIX: Better Loading Spinner */
    .loading-icon {
        color: var(--accent);
        font-size: 1.5rem;
        animation: fa-spin 1s infinite linear;
    }
    .loading-container {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        font-size: 1.1rem;
        color: var(--muted);
    }

    /* Input Grid for Admin Form & Modals */
    .input-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr); 
        gap: 12px 20px;
    }
    @media (min-width: 640px) {
        .input-grid {
            grid-template-columns: repeat(2, 1fr); /* Two columns layout */
        }
    }
    .input-grid-item {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
    }
    .input-grid .col-span-full {
        grid-column: 1 / -1;
    }
    
    /* FIX: Modal/Pop-up Styles for Preview */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    }
    .modal-content {
        background: white;
        padding: 24px;
        border-radius: 12px;
        width: 90%;
        max-width: 750px; /* Increased width for 2-column layout */
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        position: relative;
    }
    
  </style>
</head>
<body class="min-h-screen">

  <header class="glass rounded-card max-w-7xl mx-auto mt-6 p-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-4 flex-shrink-0">
      <div id="logo-placeholder" class="logo-container">PN</div>
      <div>
        <div class="text-lg font-semibold">Pakistan National Students Database</div>
        <div class="text-sm text-[--muted]">Student verification & administration</div>
      </div>
    </div>
    
    <div class="relative flex items-center gap-3 flex-shrink-0">
        <nav id="main-nav-buttons" class="hidden sm:flex items-center gap-3">
            <button id="nav-search" class="px-3 py-2 text-sm rounded hover:bg-gray-100 font-medium">Search</button> 
        </nav>

        <div id="user-session-container" class="relative ml-2 z-[10001]">
            <button id="btn-login" class="bg-[--accent] text-white px-3 py-2 rounded font-semibold hover:opacity-90">Login</button>

            <button id="user-dropdown-toggle" class="flex items-center gap-2 px-3 py-2 text-sm rounded hover:bg-gray-100 font-medium hidden">
                <span id="session-display-text" class="text-sm font-semibold text-[--accent]">Admin</span>
                <i class="fas fa-caret-down text-[--muted]"></i>
            </button>

            <div id="user-dropdown-menu" class="hidden absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                <div class="py-1">
                    <div id="session-email" class="block px-4 py-2 text-sm text-gray-500 truncate font-semibold"></div>
                    <button id="dropdown-btn-admin" class="w-full text-left block px-4 py-2 text-sm text-[--text-color] hover:bg-gray-100">Admin Panel</button>
                    <button id="dropdown-btn-logout" class="w-full text-left block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Logout</button>
                </div>
            </div>
        </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto mt-6 px-4 pb-12 space-y-6">

    <section id="section-search" class="glass rounded-card p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-semibold">Search Student Records</h1>
          <p class="text-sm text-[--muted] mt-1">Search by exact name, roll number, or student ID.</p>
        </div>
        <div class="flex gap-3 w-full md:w-auto">
          <input id="search-input" type="text" placeholder="Enter full name, roll number, or ID..." class="flex-1 border rounded px-4 py-2 focus:ring-2 focus:ring-[--accent] focus:border-[--accent]" />
          <button id="search-btn" class="bg-[--accent] text-white px-4 py-2 rounded font-semibold hover:opacity-90"><i class="fas fa-search"></i> Search</button>
          <button id="clear-search" class="bg-gray-200 text-[--muted] px-4 py-2 rounded hover:bg-gray-300"><i class="fas fa-undo"></i> Clear</button>
        </div>
      </div>
      <div id="search-results" class="grid gap-6 mt-6">
          <div id="initial-search-message" class="text-[--muted] p-6 text-center text-lg">Enter a full name, roll number, or student ID and click Search.</div>
      </div>
    </section>

    <section id="section-login" class="hidden flex items-center justify-center min-h-[40vh]">
      <div class="glass rounded-card p-8 w-full max-w-sm mx-auto shadow-xl">
        <h2 class="text-2xl font-bold mb-6 text-center text-[--accent]">Admin Login</h2>
        <form id="login-form" class="space-y-4">
          <div>
            <label for="login-email" class="block text-sm font-medium text-[--text-color]">Email Address</label>
            <input id="login-email" type="email" placeholder="admin@example.com" required class="w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[--accent] focus:border-[--accent]" />
          </div>
          <div>
            <label for="login-password" class="block text-sm font-medium text-[--text-color]">Password</label>
            <input id="login-password" type="password" placeholder="********" required class="w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[--accent] focus:border-[--accent]" />
          </div>
          <p id="login-error" class="text-sm text-red-600 hidden text-center pt-2"></p>
          <div class="flex gap-3 pt-2">
            <button type="submit" class="flex-1 bg-[--accent] text-white px-4 py-2 rounded font-semibold hover:opacity-90 transition duration-150">Sign In</button>
            <button id="cancel-login" type="button" class="flex-1 px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 transition duration-150">Cancel</button>
          </div>
        </form>
      </div>
    </section>

    <section id="section-admin" class="hidden space-y-6">
      <div class="glass rounded-card p-6">
        <div class="flex items-center justify-between">
          <div>
            <h2 id="student-form-title" class="text-xl font-semibold">Add New Student</h2>
            <p class="text-sm text-[--muted]">Fill complete details (Admins only)</p>
          </div>
        </div>

        <form id="student-form" class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-4">
          <input type="hidden" id="student_id_edit">

          <input id="name" placeholder="Full Name (e.g., Ali Khan) *" class="md:col-span-2 border rounded px-3 py-2" required>
          <input id="roll_number" placeholder="Roll Number (e.g., 10123) *" class="border rounded px-3 py-2" required>
          <input id="class" placeholder="Class (e.g., 9th A or FSC-II)" class="border rounded px-3 py-2">

          <input id="father_name" placeholder="Father's Name (e.g., Muhammad Waqas)" class="md:col-span-2 border rounded px-3 py-2">
          <input id="father_contact" placeholder="Father's Contact (e.g., 03XX-XXXXXXX)" class="border rounded px-3 py-2">
          <input id="contact_number" placeholder="Student Contact Number" class="border rounded px-3 py-2">
          
          <input id="email_student" placeholder="Student Email (optional)" type="email" class="border rounded px-3 py-2">
          <select id="gender" class="border rounded px-3 py-2">
            <option value="">Select Gender</option><option>Male</option><option>Female</option><option>Other</option>
          </select>
          <input id="blood_group" placeholder="Blood Group (e.g., A+ or B-)" class="border rounded px-3 py-2">
          <input id="dob" type="date" title="Date of Birth" class="border rounded px-3 py-2">
          
          <input id="admission_date" type="date" title="Admission Date" class="border rounded px-3 py-2">
          <input id="iq_level" placeholder="IQ Level (e.g., 105 or High)" class="border rounded px-3 py-2">
          <input id="photo" type="file" accept="image/*" title="Upload Student Photo" class="md:col-span-1 border rounded px-3 py-2 text-sm file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100" required>
          <select id="verification_status" class="border rounded px-3 py-2" title="Verification Status">
            <option value="verified">Verified</option>
            <option value="pending">Pending</option>
            <option value="rejected">Rejected</option>
            <option value="under_review">Under Review</option>
          </select>

          <textarea id="address" placeholder="Complete Address (Street, City, District)" class="md:col-span-4 border rounded px-3 py-2"></textarea>

          <div class="md:col-span-4 flex justify-end gap-3 pt-2">
            <button type="submit" id="btn-submit-student" class="bg-[--accent] text-white px-4 py-2 rounded font-semibold hover:opacity-90"><i class="fas fa-plus-circle"></i> Add Student</button>
            <button id="btn-cancel-edit" type="button" class="px-4 py-2 border rounded hover:bg-gray-100 hidden"><i class="fas fa-times-circle"></i> Cancel Edit</button>
            <button id="btn-reset" type="button" class="px-4 py-2 border rounded hover:bg-gray-100"><i class="fas fa-sync-alt"></i> Reset Form</button>
          </div>
        </form>

        <p id="form-message" class="text-sm mt-2 hidden"></p>
      </div>

      <div class="glass rounded-card p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold">Manage All Students</h3>
          <div class="flex items-center gap-3">
            <button id="btn-refresh" class="px-3 py-1 border rounded hover:bg-gray-100"><i class="fas fa-redo"></i> Refresh</button>
            <button id="btn-export" class="px-3 py-1 bg-green-500 text-white rounded font-semibold hover:bg-green-600"><i class="fas fa-file-csv"></i> Export CSV</button>
          </div>
        </div>

        <div class="mt-4 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photo</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name / ID</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roll No.</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="admin-list-body" class="bg-white divide-y divide-gray-200 text-sm">
                    <tr><td colspan="5" class="loading-container">
                        <i class="fas fa-spinner loading-icon mr-2"></i> Loading students...
                    </td></tr>
                </tbody>
            </table>
        </div>
      </div>
    </section>

    <div id="student-preview-modal" class="modal hidden">
        <div id="modal-content" class="modal-content">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-xl">
                <i class="fas fa-times-circle"></i>
            </button>
            <h3 class="text-xl font-bold border-b pb-2 mb-4 text-[--accent]">Student Full Details</h3>
            <div id="modal-body">
                </div>
        </div>
    </div>

  </main>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ---------------- CONFIG ----------------
  const SUPABASE_URL = 'https://gilsarbchgzjvcxgebcx.supabase.co'; 
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpbHNhcmJjaGd6anZjeGdlYmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNjI0NjcsImV4cCI6MjA3NTkzODQ2N30.OAz6OxL0OvAuPgy1h2GR6G07RM1zTrIkCCVSDO9tW1Q';
  const BUCKET_NAME = 'student-photos'; 
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
  // ----------------------------------------
  
  // --- SVG AND STATUS UTILITIES ---
  const LOGO_SVG = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" fill="currentColor"></path><path d="M12 14C8.13401 14 5 17.134 5 21H19C19 17.134 15.866 14 12 14Z" fill="currentColor"></path></svg>`;
  const VERIFIED_CHECK_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg>`;
  const PENDING_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 5.168A.75.75 0 008 5.75v5.5a.75.75 0 00.555.716l3 1.5a.75.75 0 00.555-1.368l-2.555-1.277V5.75a.75.75 0 00-.555-.582z" clip-rule="evenodd" /></svg>`;
  const REJECTED_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>`;
  const REVIEW_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM8.94 6.94a.75.75 0 11-1.06-1.061l2.5-2.5a.75.75 0 011.06 0l2.5 2.5a.75.75 0 11-1.06 1.061L12 5.687V9.25a.75.75 0 01-1.5 0V5.687L8.94 6.94zM10 15a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>`;
  const STATUS_STAMPS_B64 = {
      verified: 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="rgba(16, 185, 129, 0.1)" stroke="#10b981" stroke-width="3"/><path d="M30 50 L45 68 L75 35" stroke="#10b981" stroke-width="8" fill="none" stroke-linecap="round"/><text x="50" y="85" font-family="sans-serif" font-size="12" fill="#10b981" text-anchor="middle" font-weight="bold">VERIFIED</text></svg>`),
      pending: 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="rgba(249, 115, 22, 0.1)" stroke="#f97316" stroke-width="3"/><text x="50" y="58" font-family="sans-serif" font-size="12" fill="#f97316" text-anchor="middle" font-weight="bold">PENDING</text></svg>`),
      rejected: 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="rgba(239, 68, 68, 0.1)" stroke="#ef4444" stroke-width="3"/><line x1="35" y1="35" x2="65" y2="65" stroke="#ef4444" stroke-width="8" stroke-linecap="round"/><line x1="65" y1="35" x2="35" y2="65" stroke="#ef4444" stroke-width="8" stroke-linecap="round"/><text x="50" y="85" font-family="sans-serif" font-size="12" fill="#ef4444" text-anchor="middle" font-weight="bold">REJECTED</text></svg>`),
      under_review: 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="rgba(59, 130, 246, 0.1)" stroke="#3b82f6" stroke-width="3"/><text x="50" y="58" font-family="sans-serif" font-size="12" fill="#3b82f6" text-anchor="middle" font-weight="bold">IN REVIEW</text></svg>`),
  };


  // DOM refs 
  const logoPlaceholder = document.getElementById('logo-placeholder');
  const navSearch = document.getElementById('nav-search'); 
  const btnLogin = document.getElementById('btn-login');
  const userDropdownToggle = document.getElementById('user-dropdown-toggle');
  const userDropdownMenu = document.getElementById('user-dropdown-menu');
  const sessionEmail = document.getElementById('session-email');
  const dropdownBtnAdmin = document.getElementById('dropdown-btn-admin');
  const dropdownBtnLogout = document.getElementById('dropdown-btn-logout');
  const sectionSearch = document.getElementById('section-search');
  const sectionLogin = document.getElementById('section-login');
  const sectionAdmin = document.getElementById('section-admin');
  const searchInput = document.getElementById('search-input');
  const searchBtn = document.getElementById('search-btn');
  const clearSearch = document.getElementById('clear-search');
  const searchResults = document.getElementById('search-results');
  const initialSearchMessage = document.getElementById('initial-search-message');
  const loginForm = document.getElementById('login-form');
  const loginError = document.getElementById('login-error');
  const cancelLogin = document.getElementById('cancel-login');
  const studentForm = document.getElementById('student-form');
  const studentFormTitle = document.getElementById('student-form-title');
  const btnSubmitStudent = document.getElementById('btn-submit-student');
  const btnReset = document.getElementById('btn-reset');
  const btnCancelEdit = document.getElementById('btn-cancel-edit');
  const formMessage = document.getElementById('form-message');
  const studentIdEdit = document.getElementById('student_id_edit');
  const photoInput = document.getElementById('photo');
  const adminListBody = document.getElementById('admin-list-body');
  const btnRefresh = document.getElementById('btn-refresh');
  const btnExport = document.getElementById('btn-export');
  const modal = document.getElementById('student-preview-modal');
  const modalBody = document.getElementById('modal-body');
  const modalCloseBtn = document.getElementById('modal-close-btn');

  let cachedStudents = [];

  function getStatusHtml(status) {
    status = (status || 'pending').toLowerCase();
    switch (status) {
      case 'verified': return `<span class="flex items-center gap-1">${VERIFIED_CHECK_SVG} Verified</span>`;
      case 'pending': return `<span class="flex items-center gap-1">${PENDING_SVG} Pending</span>`;
      case 'rejected': return `<span class="flex items-center gap-1">${REJECTED_SVG} Rejected</span>`;
      case 'under_review': return `<span class="flex items-center gap-1">${REVIEW_SVG} Review</span>`;
      default: return `<span class="flex items-center gap-1">${PENDING_SVG} Pending</span>`;
    }
  }
  
  function getBadgeClass(status) {
      status = (status || 'pending').toLowerCase();
      if (status === 'verified') return 'badge-verified';
      if (status === 'pending') return 'badge-pending';
      if (status === 'rejected') return 'badge-rejected';
      if (status === 'under_review') return 'badge-review';
      return 'badge-pending';
  }

  function getBorderClass(status) {
    status = (status || 'pending').toLowerCase();
    if (status === 'verified') return 'border-verified';
    if (status === 'pending') return 'border-pending';
    if (status === 'rejected') return 'border-rejected';
    if (status === 'under_review') return 'border-review';
    return '';
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"'/]/g, s => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;','/': '&#x2F;'})[s]);
  }
  
  function applyWatermark(doc, text) {
      for (let i = 1; i <= doc.internal.pages.length; i++) {
          doc.setPage(i);
          doc.setTextColor(200);
          doc.setGState(new doc.GState({ opacity: 0.1 })); 
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(70);
          doc.text(text, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() / 2, null, 45, 'center');
          doc.setGState(new doc.GState({ opacity: 1.0 }));
          doc.setTextColor(0);
      }
  }


  // --- EVENT LISTENERS ---
  navSearch.addEventListener('click', ()=> showSection('search'));
  btnLogin.addEventListener('click', ()=> showSection('login'));
  cancelLogin?.addEventListener('click', ()=> showSection('search'));
  searchBtn.addEventListener('click', async ()=> { await doSearch(searchInput.value.trim()); });
  clearSearch.addEventListener('click', ()=> { searchInput.value=''; renderSearchResults([]); });
  btnRefresh.addEventListener('click', loadStudentsAdmin);
  btnExport.addEventListener('click', exportStudentsToCsv);
  btnReset.addEventListener('click', ()=> resetForm());
  btnCancelEdit.addEventListener('click', ()=> resetForm());
  dropdownBtnAdmin.addEventListener('click', () => { userDropdownMenu.classList.add('hidden'); checkAuthAndShowAdmin(); });
  dropdownBtnLogout.addEventListener('click', handleLogout);
  userDropdownToggle.addEventListener('click', () => { userDropdownMenu.classList.toggle('hidden'); });
  modalCloseBtn.addEventListener('click', () => { modal.classList.add('hidden'); });
  document.addEventListener('click', (e) => { // Close dropdown if clicked outside
    if (!userDropdownToggle.contains(e.target) && !userDropdownMenu.contains(e.target)) {
      userDropdownMenu.classList.add('hidden');
    }
  });


  // --- INITIALIZATION ---
  (async function init(){
    logoPlaceholder.innerHTML = LOGO_SVG;
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) onSignIn(session.user.email);
    else onSignOut();
    showSection('search'); 
    await preloadStudents();
    renderSearchResults([]);
  })();

  // --- Auth and Navigation ---
  function showSection(name){
    [sectionSearch, sectionLogin, sectionAdmin].forEach(s => s.classList.add('hidden'));
    userDropdownMenu.classList.add('hidden');

    if (name === 'search') sectionSearch.classList.remove('hidden');
    if (name === 'login') sectionLogin.classList.remove('hidden');
    if (name === 'admin') sectionAdmin.classList.remove('hidden');
  }

  function onSignIn(email){
    btnLogin.classList.add('hidden'); 
    userDropdownToggle.classList.remove('hidden');
    sessionEmail.textContent = email;
  }
  function onSignOut(){
    btnLogin.classList.remove('hidden'); 
    userDropdownToggle.classList.add('hidden');
    userDropdownMenu.classList.add('hidden'); 
    showSection('search');
  }

  async function handleLogout() {
    await supabase.auth.signOut(); 
    onSignOut(); 
    showSection('search');
    searchInput.value = '';
    renderSearchResults([]);
  }

  async function checkAuthAndShowAdmin(){
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) showSection('login');
    else { onSignIn(session.user.email); showSection('admin'); await loadStudentsAdmin(); }
  }

  // --- LOGIN ---
  loginForm?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    loginError.classList.add('hidden');
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        if (data?.user) { 
            onSignIn(data.user.email); 
            await checkAuthAndShowAdmin(); 
            await preloadStudents(); 
        } else { throw new Error('Login failed: Invalid credentials.'); }
    } catch (error) {
        loginError.textContent = error.message.includes('Invalid login credentials') ? 'Invalid Email or Password' : error.message;
        loginError.classList.remove('hidden');
    }
  });

  // --- PRELOAD & SEARCH ---
  async function preloadStudents(){
    try {
      const { data } = await supabase.from('students').select('*').order('created_at',{ascending:false}).limit(1000); 
      cachedStudents = data || [];
    } catch (err){ console.error("Preload failed:", err); cachedStudents = []; }
  }

  async function doSearch(q){
    initialSearchMessage.classList.add('hidden');
    searchResults.innerHTML = `<div class="loading-container"><i class="fas fa-spinner loading-icon mr-2"></i> Searching records...</div>`;
    if (!q) { renderSearchResults([]); return; }

    // FIX: Prioritize exact matches
    const { data, error } = await supabase.from('students').select('*')
      .or(`name.eq.${q},roll_number.eq.${q},student_id.eq.${q},name.ilike.%${q}%`)
      .order('created_at',{ascending:false}).limit(20);
    
    if (error) { searchResults.innerHTML = `<div class="text-red-600 p-4 text-center">Search failed: ${error.message}</div>`; return; }
    
    if (data.length === 0) {
        searchResults.innerHTML = `<div class="text-[--muted] p-6 text-center">No students found matching "${escapeHtml(q)}".</div>`;
        return;
    }
    renderSearchResults(data);
  }

  function renderSearchResults(list){
    searchResults.innerHTML = '';
    if (!list || list.length === 0){
        if(searchInput.value.trim() === '') {
             initialSearchMessage.classList.remove('hidden');
             return;
        }
        searchResults.innerHTML = `<div class="text-[--muted] p-6 text-center">No students found matching your query.</div>`;
        return;
    }
    initialSearchMessage.classList.add('hidden');

    list.forEach(s => {
      const status = s.verification_status || 'pending';
      const photoUrl = escapeHtml(s.photo_url) || 'https://via.placeholder.com/160x180?text=No+Photo';

      const studentCard = document.createElement('div');
      studentCard.className = `search-result-card card-hover ${getBorderClass(status)}`; 
      // FIX: New layout with all data in readonly inputs
      studentCard.innerHTML = `
        <div class="student-photo-section flex flex-col items-center justify-start pt-2">
            <img src="${photoUrl}" class="w-full h-auto object-cover rounded-md shadow-md mb-3 max-w-[160px]">
            <span class="status-badge ${getBadgeClass(status)}">${getStatusHtml(status)}</span>
        </div>
        <div class="student-details-section w-full">
            <div class="border-b border-gray-200 pb-2 mb-4">
                <h3 class="text-2xl font-bold text-[--accent]">${escapeHtml(s.name)}</h3>
            </div>
            <div class="input-grid">
                <div class="input-grid-item"><label>Student ID</label><input type="text" value="${escapeHtml(s.student_id || '-')}" readonly></div>
                <div class="input-grid-item"><label>Roll Number</label><input type="text" value="${escapeHtml(s.roll_number || '-')}" readonly></div>
                <div class="input-grid-item"><label>Class/Grade</label><input type="text" value="${escapeHtml(s.class || '-')}" readonly></div>
                <div class="input-grid-item"><label>IQ Level</label><input type="text" value="${escapeHtml(s.iq_level || '-')}" readonly></div>
                <div class="input-grid-item"><label>Father's Name</label><input type="text" value="${escapeHtml(s.father_name || '-')}" readonly></div>
                <div class="input-grid-item"><label>Father's Contact</label><input type="text" value="${escapeHtml(s.father_contact || '-')}" readonly></div>
                <div class="input-grid-item"><label>DOB</label><input type="text" value="${escapeHtml(s.dob || 'N/A')}" readonly></div>
                <div class="input-grid-item"><label>Gender</label><input type="text" value="${escapeHtml(s.gender || 'N/A')}" readonly></div>
                <div class="input-grid-item"><label>Blood Group</label><input type="text" value="${escapeHtml(s.blood_group || 'N/A')}" readonly></div>
                <div class="input-grid-item"><label>Student Contact</label><input type="text" value="${escapeHtml(s.contact_number || 'N/A')}" readonly></div>
                <div class="input-grid-item col-span-full"><label>Email Address</label><input type="text" value="${escapeHtml(s.email_student || 'N/A')}" readonly></div>
                <div class="input-grid-item col-span-full"><label>Address</label><textarea rows="2" class="w-full" readonly>${escapeHtml(s.address || 'N/A')}</textarea></div>
            </div>
            <div class="mt-6 flex justify-end w-full border-t pt-4 gap-3">
                <button class="px-4 py-2 bg-blue-500 text-white rounded text-sm font-medium hover:bg-blue-600 preview-btn" data-id="${s.id}"><i class="fas fa-eye"></i> Full Preview</button>
                <button class="px-4 py-2 bg-gray-200 text-black rounded text-sm font-medium hover:bg-gray-300 print-btn" data-id="${s.id}"><i class="fas fa-file-pdf"></i> Download PDF</button>
            </div>
        </div>
      `;
      searchResults.appendChild(studentCard);
    });

    document.querySelectorAll('.print-btn').forEach(btn => btn.addEventListener('click', async (e) => {
        const student = list.find(s => String(s.id) === e.currentTarget.getAttribute('data-id'));
        if (student) await generatePdfForStudent(student);
    }));
    document.querySelectorAll('.preview-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const student = list.find(s => String(s.id) === e.currentTarget.getAttribute('data-id'));
        if (student) showStudentPreviewModal(student);
    }));
  }
  
  // FIX: Full Preview Modal with 2-column layout
  function showStudentPreviewModal(student) {
    const status = student.verification_status || 'pending';
    const photoUrl = escapeHtml(student.photo_url) || 'https://via.placeholder.com/100x100?text=No+Photo';

    modalBody.innerHTML = `
        <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
            <img src="${photoUrl}" class="w-24 h-24 object-cover rounded-md shadow-md flex-shrink-0">
            <div>
                <h4 class="text-2xl font-bold text-[--accent]">${escapeHtml(student.name)}</h4>
                <div class="text-sm text-gray-500 mt-1">ID: ${escapeHtml(student.student_id)} / Roll No: ${escapeHtml(student.roll_number)}</div>
                <span class="status-badge ${getBadgeClass(status)} mt-2">${getStatusHtml(status)}</span>
            </div>
        </div>
        <div class="input-grid">
            <div class="input-grid-item"><label>Class/Grade</label><input type="text" value="${escapeHtml(student.class || '-')}" readonly></div>
            <div class="input-grid-item"><label>IQ Level</label><input type="text" value="${escapeHtml(student.iq_level || '-')}" readonly></div>
            <div class="input-grid-item"><label>Father's Name</label><input type="text" value="${escapeHtml(student.father_name || '-')}" readonly></div>
            <div class="input-grid-item"><label>Father's Contact</label><input type="text" value="${escapeHtml(student.father_contact || '-')}" readonly></div>
            <div class="input-grid-item"><label>DOB</label><input type="text" value="${escapeHtml(student.dob || 'N/A')}" readonly></div>
            <div class="input-grid-item"><label>Gender</label><input type="text" value="${escapeHtml(student.gender || 'N/A')}" readonly></div>
            <div class="input-grid-item"><label>Blood Group</label><input type="text" value="${escapeHtml(student.blood_group || 'N/A')}" readonly></div>
            <div class="input-grid-item"><label>Student Contact</label><input type="text" value="${escapeHtml(student.contact_number || 'N/A')}" readonly></div>
            <div class="col-span-full input-grid-item"><label>Email Address</label><input type="text" value="${escapeHtml(student.email_student || 'N/A')}" readonly></div>
            <div class="col-span-full input-grid-item"><label>Complete Address</label><textarea rows="2" class="w-full" readonly>${escapeHtml(student.address || 'Address not provided.')}</textarea></div>
        </div>
    `;
    modal.classList.remove('hidden');
  }

  // --- ADMIN PANEL MANAGEMENT ---
  async function loadStudentsAdmin(){
    adminListBody.innerHTML = `<tr><td colspan="5" class="loading-container"><i class="fas fa-spinner loading-icon mr-2"></i> Loading students...</td></tr>`;
    try {
        const { data, error } = await supabase.from('students').select('*').order('created_at', {ascending: false});
        if (error) throw error;
        cachedStudents = data; // Update cache
        renderAdminList(data);
    } catch (err) {
        adminListBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-600">Error: ${err.message}</td></tr>`;
    }
  }

  function renderAdminList(list){
    adminListBody.innerHTML = '';
    if (!list || list.length === 0){
        adminListBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-[--muted]">No students found. Add one to get started.</td></tr>`;
        return;
    }

    list.forEach(s => {
      const status = s.verification_status || 'pending';
      const photoUrl = escapeHtml(s.photo_url) || 'https://via.placeholder.com/40x40?text=P';

      const row = document.createElement('tr');
      row.className = 'hover:bg-gray-50';
      // FIX: Added Preview, PDF, and Delete buttons
      row.innerHTML = `
        <td class="px-3 py-3 whitespace-nowrap"><img src="${photoUrl}" alt="Photo" class="w-10 h-10 object-cover rounded-md border"></td>
        <td class="px-3 py-3 whitespace-nowrap font-medium">${escapeHtml(s.name)}<div class="text-xs text-[--muted]">ID: ${escapeHtml(s.student_id)}</div></td>
        <td class="px-3 py-3 whitespace-nowrap">${escapeHtml(s.roll_number)}</td>
        <td class="px-3 py-3 whitespace-nowrap"><span class="status-badge ${getBadgeClass(status)}">${getStatusHtml(status)}</span></td>
        <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex justify-end items-center gap-3 text-lg">
                <button title="Preview" class="text-blue-600 hover:text-blue-800 preview-btn-admin" data-id="${s.id}"><i class="fas fa-eye"></i></button>
                <button title="Download PDF" class="text-green-600 hover:text-green-800 pdf-btn-admin" data-id="${s.id}"><i class="fas fa-file-pdf"></i></button>
                <button title="Edit" class="text-teal-600 hover:text-teal-800 edit-btn" data-id="${s.id}"><i class="fas fa-edit"></i></button>
                <button title="Delete" class="text-red-600 hover:text-red-800 delete-btn" data-id="${s.id}" data-photo-url="${s.photo_url}"><i class="fas fa-trash"></i></button>
            </div>
        </td>
      `;
      adminListBody.appendChild(row);
    });

    // Add event listeners for all new buttons
    adminListBody.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const student = cachedStudents.find(x => String(x.id) === e.currentTarget.getAttribute('data-id'));
        if(student) openEditForm(student);
    }));
    adminListBody.querySelectorAll('.pdf-btn-admin').forEach(btn => btn.addEventListener('click', async (e) => {
        const student = cachedStudents.find(x => String(x.id) === e.currentTarget.getAttribute('data-id'));
        if (student) await generatePdfForStudent(student);
    }));
    adminListBody.querySelectorAll('.preview-btn-admin').forEach(btn => btn.addEventListener('click', (e) => {
        const student = cachedStudents.find(x => String(x.id) === e.currentTarget.getAttribute('data-id'));
        if (student) showStudentPreviewModal(student);
    }));
    adminListBody.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        const photoUrlToDelete = e.currentTarget.getAttribute('data-photo-url');
        await handleDeleteStudent(id, photoUrlToDelete);
    }));
  }

  async function handleDeleteStudent(id, photoUrl) {
    if (!confirm('Are you sure you want to delete this student? This action is irreversible.')) return;
    try {
        // 1. Delete Photo from Storage (if it exists)
        if (photoUrl && photoUrl.includes(BUCKET_NAME)) {
            const filePath = photoUrl.substring(photoUrl.indexOf(BUCKET_NAME) + BUCKET_NAME.length + 1);
            const { error: storageError } = await supabase.storage.from(BUCKET_NAME).remove([filePath]);
            if (storageError) console.error("Could not delete photo:", storageError.message);
        }
        // 2. Delete Record from Database
        const { error: dbError } = await supabase.from('students').delete().eq('id', id);
        if (dbError) throw dbError;

        alert('Student deleted successfully.');
        await loadStudentsAdmin(); // Refresh list
        await preloadStudents();   // Refresh cache
    } catch (error) {
        alert(`Error deleting student: ${error.message}`);
    }
  }

  function openEditForm(student) {
    studentIdEdit.value = student.id;
    studentForm.elements['name'].value = student.name || '';
    studentForm.elements['roll_number'].value = student.roll_number || '';
    studentForm.elements['email_student'].value = student.email_student || '';
    studentForm.elements['gender'].value = student.gender || '';
    studentForm.elements['class'].value = student.class || '';
    studentForm.elements['father_name'].value = student.father_name || '';
    studentForm.elements['father_contact'].value = student.father_contact || '';
    studentForm.elements['contact_number'].value = student.contact_number || '';
    studentForm.elements['blood_group'].value = student.blood_group || '';
    studentForm.elements['dob'].value = student.dob || '';
    studentForm.elements['admission_date'].value = student.admission_date || '';
    studentForm.elements['iq_level'].value = student.iq_level || '';
    studentForm.elements['verification_status'].value = student.verification_status || 'pending';
    studentForm.elements['address'].value = student.address || '';
    studentFormTitle.textContent = `Edit Student: ${student.name}`;
    btnSubmitStudent.innerHTML = '<i class="fas fa-save"></i> Save Changes';
    btnSubmitStudent.classList.replace('bg-[--accent]', 'bg-blue-600');
    btnSubmitStudent.classList.replace('hover:opacity-90', 'hover:bg-blue-700');
    btnCancelEdit.classList.remove('hidden');
    photoInput.required = false;
    document.getElementById('section-admin').scrollIntoView({ behavior: 'smooth' });
  }

  function resetForm() {
    studentForm.reset();
    studentIdEdit.value = '';
    studentFormTitle.textContent = 'Add New Student';
    btnSubmitStudent.innerHTML = '<i class="fas fa-plus-circle"></i> Add Student';
    btnSubmitStudent.classList.replace('bg-blue-600','bg-[--accent]');
    btnSubmitStudent.classList.replace('hover:bg-blue-700', 'hover:opacity-90');
    btnCancelEdit.classList.add('hidden');
    formMessage.classList.add('hidden');
    photoInput.required = true;
  }

  // --- ADD/EDIT SUBMISSION ---
  studentForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    formMessage.classList.add('hidden');
    btnSubmitStudent.disabled = true;

    const isEdit = !!studentIdEdit.value;
    const formData = {
      name: studentForm.elements['name'].value.trim(),
      roll_number: studentForm.elements['roll_number'].value.trim(),
      email_student: studentForm.elements['email_student'].value.trim() || null,
      gender: studentForm.elements['gender'].value || null,
      class: studentForm.elements['class'].value.trim() || null,
      father_name: studentForm.elements['father_name'].value.trim() || null,
      father_contact: studentForm.elements['father_contact'].value.trim() || null,
      contact_number: studentForm.elements['contact_number'].value.trim() || null,
      blood_group: studentForm.elements['blood_group'].value.trim() || null,
      dob: studentForm.elements['dob'].value || null,
      admission_date: studentForm.elements['admission_date'].value || null,
      iq_level: studentForm.elements['iq_level'].value.trim() || null, 
      verification_status: studentForm.elements['verification_status'].value,
      address: studentForm.elements['address'].value.trim() || null,
    };
    const photoFile = photoInput.files[0];

    try {
      if (photoFile) {
        const filePath = `public/${formData.roll_number}_${Date.now()}.${photoFile.name.split('.').pop()}`;
        const { error: uploadError } = await supabase.storage.from(BUCKET_NAME).upload(filePath, photoFile);
        if (uploadError) throw new Error(`Photo upload failed: ${uploadError.message}`);
        const { data: { publicUrl } } = supabase.storage.from(BUCKET_NAME).getPublicUrl(filePath);
        formData.photo_url = publicUrl;
      }
      const dbResponse = isEdit 
        ? await supabase.from('students').update(formData).eq('id', studentIdEdit.value).select()
        : await supabase.from('students').insert([{ ...formData, student_id: `PNSD-${Date.now().toString().slice(-7)}` }]).select();

      if (dbResponse.error) throw dbResponse.error;
      showMessage('success', `Student "${formData.name}" was ${isEdit ? 'updated' : 'added'} successfully!`);
      resetForm();
      await loadStudentsAdmin();
      await preloadStudents();
    } catch (error) {
      showMessage('error', `Operation failed: ${error.message}`);
    } finally {
      btnSubmitStudent.disabled = false;
    }
  });

  function showMessage(type, message) {
    formMessage.textContent = message;
    formMessage.classList.remove('hidden', 'text-green-600', 'text-red-600');
    formMessage.classList.add(type === 'success' ? 'text-green-600' : 'text-red-600');
  }

  // --- CSV Export ---
  async function exportStudentsToCsv(){
    if (!cachedStudents.length) return alert('No data to export.');
    const headers = Object.keys(cachedStudents[0]);
    let csv = headers.join(',') + '\n';
    cachedStudents.forEach(row => {
        csv += headers.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(',') + '\n';
    });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
    link.download = `students_export_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
  }

  // --- PDF Generation ---
  async function urlToBase64(url) {
      if (!url || url.includes('placeholder.com')) return null;
      try {
          const response = await fetch(url);
          const blob = await response.blob();
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(blob);
          });
      } catch (e) { console.error("Base64 conversion failed:", e); return null; }
  }

  async function generatePdfForStudent(student) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

    const ACCENT_COLOR = '#0ea5a4';
    const CARD_X = 10, CARD_Y = 10;
    const PAGE_WIDTH = doc.internal.pageSize.getWidth();
    const CARD_WIDTH = PAGE_WIDTH - (CARD_X * 2); 
    const status = student.verification_status || 'pending';
    
    let photoBase64 = await urlToBase64(student.photo_url);

    // Header Bar
    doc.setFillColor(ACCENT_COLOR);
    doc.rect(0, CARD_Y, PAGE_WIDTH, 15, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.setTextColor(255);
    const logoBase64 = 'data:image/svg+xml;base64,' + btoa(LOGO_SVG);
    doc.addImage(logoBase64, 'SVG', CARD_X + 2, CARD_Y + 2, 11, 11);
    doc.text('PAKISTAN NATIONAL STUDENTS DATABASE - OFFICIAL RECORD', PAGE_WIDTH / 2, CARD_Y + 9, { align: 'center' });

    // Main Card
    doc.setDrawColor(200);
    doc.roundedRect(CARD_X, CARD_Y + 18, CARD_WIDTH, 260, 3, 3, 'D');

    // Photo & Status Stamp
    const PHOTO_SIZE = 40;
    const PHOTO_X = CARD_X + 8;
    const PHOTO_Y = CARD_Y + 25;
    if (photoBase64) {
        doc.addImage(photoBase64, 'JPEG', PHOTO_X, PHOTO_Y, PHOTO_SIZE, PHOTO_SIZE);
    } else {
        doc.setFillColor(230).rect(PHOTO_X, PHOTO_Y, PHOTO_SIZE, PHOTO_SIZE, 'F');
        doc.setTextColor(150).text('No Photo', PHOTO_X + PHOTO_SIZE/2, PHOTO_Y + PHOTO_SIZE/2, { align: 'center' });
    }
    // FIX: Add status stamp next to photo
    const statusStamp = STATUS_STAMPS_B64[status] || STATUS_STAMPS_B64['pending'];
    doc.addImage(statusStamp, 'SVG', PHOTO_X + PHOTO_SIZE - 5, PHOTO_Y + PHOTO_SIZE - 15, 25, 25);


    // Primary Details
    let detailX = PHOTO_X + PHOTO_SIZE + 10;
    let detailY = PHOTO_Y + 5;
    doc.setTextColor(ACCENT_COLOR).setFontSize(22).setFont('helvetica', 'bold').text(student.name || 'N/A', detailX, detailY);
    detailY += 8;
    doc.setTextColor(50).setFontSize(10).setFont('helvetica', 'normal');
    doc.text(`Student ID: ${student.student_id || '-'}`, detailX, detailY);
    detailY += 6;
    doc.text(`Roll Number: ${student.roll_number || '-'}`, detailX, detailY);
    detailY += 6;
    doc.text(`Class: ${student.class || '-'}`, detailX, detailY);

    // Data Table
    let tableY = PHOTO_Y + PHOTO_SIZE + 15;
    const data = [
        ["Father's Name", student.father_name || '-'],
        ["Father's Contact", student.father_contact || '-'],
        ["Gender", student.gender || '-'], ["DOB", student.dob || '-'],
        ["Blood Group", student.blood_group || '-'], ["IQ Level", student.iq_level || '-'],
        ["Admission Date", student.admission_date || '-'], ["Student Contact", student.contact_number || '-'],
        [{ content: 'Email Address', colSpan: 2}, { content: student.email_student || '-', colSpan: 2}],
        [{ content: 'Address', colSpan: 2}, { content: student.address || '-', colSpan: 2}],
    ];
    doc.autoTable({
        startY: tableY,
        body: data,
        theme: 'grid',
        styles: { fontSize: 9, cellPadding: 2.5, textColor: '#0f172a', lineColor: 220, lineWidth: 0.1 },
        columnStyles: { 0: { fontStyle: 'bold', fillColor: [248, 250, 252] }, 2: { fontStyle: 'bold', fillColor: [248, 250, 252] } },
        margin: { left: CARD_X + 5, right: CARD_X + 5 }
    });
    
    applyWatermark(doc, 'OFFICIAL'); 
    
    // Footer
    let footerY = 285;
    doc.setFontSize(8).setFont('helvetica', 'italic').setTextColor(150);
    doc.text(`Generated on: ${new Date().toLocaleString()}`, CARD_X, footerY);
    doc.text(`Status: ${status.replace('_',' ').toUpperCase()}`, PAGE_WIDTH - CARD_X, footerY, { align: 'right' });

    doc.save(`${(student.roll_number || student.student_id)}_Record.pdf`);
  }
</script>
</body>
</html>
